# Люмбритовые шахты Кальдерна — План разработки

## 1. Концепция

**Жанр:** 2D exploration / story-driven adventure с элементами horror  
**Визуальные ориентиры:** Celeste (пиксель-арт, чистота анимаций), Noita (атмосфера подземелья, частицы, освещение)  
**Нарративные ориентиры:** Hollow Knight (масштаб мира, environmental storytelling), SOMA (тихий ужас, философия), Darkest Dungeon (давление среды на разум), Disco Elysium (глубокие NPC, политика, упадок)  
**Тон:** Холод, темнота, клаустрофобия. Красота в распаде. NPC, которые держатся за остатки нормальности в ненормальном месте. Финал — не босс, а понимание.

### Сеттинг

Кальдерн — подземный город-шахта, некогда процветавший центр добычи **люмбрита** — редчайшей руды, которая являлась уникальным источником энергии (аналог Специи из Дюны). Город привлекал тысячи людей. Но руда истощалась, шахты уходили всё глубже, логистика дорожала. Рабочие годами не видели солнца. Люмбрит излучал странную энергию — физически и психически менявшую людей. Безумие, деспотизм начальников, бунты, обрушения. За последние 10-20 лет большая часть города заброшена. На верхних уровнях ещё добывают крупицы люмбрита для чёрного рынка.

**Люмбрит (Lumbrite)** — от "lumen" (свет) + "umbra" (тень). Светится холодным светом в темноте. Источник энергии для паровых механизмов Кальдерна. При длительном воздействии меняет людей — физически и психически. Чем глубже залежи, тем ярче свечение и сильнее воздействие. На самом дне люмбрит слепит.

### Стимпанк-элементы

- Паровые лифты между уровнями (некоторые работают, некоторые нужно чинить)
- Пневмопочта — старая система сообщений. Игрок находит застрявшие капсулы с письмами (лор + квестовые предметы)
- Паровые вентиляционные системы — обеспечивали воздух на нижних уровнях, многие сломаны
- Люмбритовые генераторы — руда как топливо для паровых машин. На нижних уровнях генераторы всё ещё работают, питаемые жилами в стенах. Заброшенный завод, в котором машины крутятся сами по себе

### Структура мира (вертикальная)

**Верхние уровни — «Край»**  
Ещё живые, полулегальные. Чёрный рынок люмбрита, бары, торговцы снаряжением, бывшие шахтёры, которые не смогли уйти. Паровые лифты ещё работают, но ненадёжно. Первые зацепки о гуманитарной группе.

**Средние уровни — «Хребет»**  
Заброшенные жилые кварталы, мастерские, паровые станции. Школы, больницы, парки с люмбритовыми лампами. Пусто, но видны следы жизни. Отшельники. Следы гуманитарной миссии — граффити, записки, лагеря.

**Нижние уровни — «Кишки»**  
Промышленные зоны, шахты, перерабатывающие заводы. Затопленные тоннели, обрушения, баррикады от бунтов. Люмбрит в стенах светится сильнее. Люди здесь изменены — не монстры, но и не те, кем были. Своя логика, своя «правда».

**Дно — «Корень»**  
Никто не знает, что там. Старые карты обрываются. Люмбрит слепит. Воздействие на максимуме. Здесь нет ответа — есть вопрос. Как в концовке «Космической одиссеи»: что-то непонятное, что заставляет переосмыслить всё, что было до этого. Никакого фэнтези — только ощущение чего-то за пределами понимания.

### Сюжет

Главный герой — расследователь со спелеологическим опытом. Однажды уже спускался в Кальдерн, но не дальше средних уровней. Нанят состоятельным человеком: найти его дочь, которая пару лет назад спустилась с группой гуманитарной помощи и пропала. Отец отчасти потерял надежду, но хочет узнать, что случилось, и если получится — найти тело.

Игра — расследование. По пути вниз раскрываются: история бунтов, жизнь в городе, истории NPC (почему они всё ещё здесь, ностальгия по былому). Темы: отношения, тяжёлые выборы, деспотизм, эксплуатация.

### Люмбритовое воздействие (геймплей)

Не HP-бар, а атмосферный инструмент. Чем глубже и дольше рядом с люмбритом — тем сильнее эффекты: визуальные искажения, изменение палитры, возможно галлюцинации (NPC, которые говорят странное — реальны ли они?). Ближе к Darkest Dungeon stress, но мягче и нарративнее.

---

## 2. Технический стек

### Основной стек

| Компонент | Технология | Версия | Почему |
|-----------|-----------|--------|--------|
| Язык | TypeScript | 5.x | Строгая типизация, лучшая поддержка AI-агентом |
| Рендер | PixiJS | v8 | WebGL, быстрый, зрелый. Только рендер, без навязанной архитектуры |
| Сборка | Vite | 6.x | HMR, быстрый dev-сервер, простая конфигурация |
| Тесты | Vitest | latest | Нативная интеграция с Vite, быстрые, TypeScript из коробки |
| Линтер | ESLint + Prettier | latest | Единый стиль кода |
| Десктоп | Tauri | v2 | Для Steam-билда. 5-15MB вместо 150MB+ Electron |
| CI | GitHub Actions | — | Автотесты на каждый push |

### Принцип: PixiJS — только рендер

PixiJS используется исключительно как графическая библиотека. Вся игровая логика — в собственном коде:
- Game loop (свой)
- Система сущностей (своя, простая, не полноценный ECS)
- Камера (своя)
- Коллизии (свои, AABB для тайлов)
- Тайлмап-система (своя)
- Диалоговая система (своя)
- Система сохранений (своя, IndexedDB)
- Input-менеджер (свой)
- Audio-менеджер (Web Audio API / Howler.js)

**Почему не Phaser:** Phaser навязывает архитектуру (Scene-based), скрывает внутреннее состояние, создаёт «магические» баги. AI-агент эффективнее работает с кодом, который сам написал. Каждая строчка понятна, каждая строчка изменяема.

---

## 3. Архитектура проекта

### Структура директорий

```
caldern/
├── CLAUDE.md                    # Инструкции для AI-агента
├── package.json
├── tsconfig.json
├── vite.config.ts
├── vitest.config.ts
├── index.html
│
├── src/
│   ├── main.ts                  # Точка входа, инициализация
│   │
│   ├── core/                    # Ядро движка (переиспользуемое)
│   │   ├── Game.ts              # Game loop, тайминг, состояния
│   │   ├── Scene.ts             # Базовый класс сцены (не Phaser — простой контейнер)
│   │   ├── SceneManager.ts      # Переключение сцен, lifecycle
│   │   ├── Camera.ts            # 2D камера, следование, зоны, тряска
│   │   ├── InputManager.ts      # Keyboard + Gamepad, rebindable actions
│   │   ├── AudioManager.ts      # Music, SFX, ambient, crossfade
│   │   ├── AssetLoader.ts       # Загрузка и кэширование ассетов
│   │   ├── SaveManager.ts       # IndexedDB, автосохранение, слоты
│   │   └── EventBus.ts          # Глобальная шина событий (typed)
│   │
│   ├── physics/                 # Физика и коллизии
│   │   ├── CollisionSystem.ts   # AABB коллизии с тайлмапом
│   │   ├── Body.ts              # Физическое тело (позиция, скорость, гравитация)
│   │   └── Raycaster.ts         # Лучи для платформинга и line-of-sight
│   │
│   ├── world/                   # Мир и тайлы
│   │   ├── TileMap.ts           # Загрузка, рендер, коллизии тайлмапа
│   │   ├── Chunk.ts             # Чанк мира (для больших уровней)
│   │   ├── ChunkManager.ts      # Загрузка/выгрузка чанков вокруг камеры
│   │   ├── Layer.ts             # Слой тайлмапа (background, collision, foreground)
│   │   ├── Zone.ts              # Триггер-зоны (переходы, события, ambient)
│   │   └── Parallax.ts          # Параллакс-слои для фона
│   │
│   ├── entities/                # Игровые сущности
│   │   ├── Entity.ts            # Базовая сущность (позиция, спрайт, update)
│   │   ├── Player.ts            # Игрок: движение, анимации, инвентарь
│   │   ├── NPC.ts               # NPC: диалоги, расписание, состояния
│   │   ├── InteractiveObject.ts # Рычаги, двери, пневмопочта, лифты
│   │   └── EntityManager.ts     # Управление всеми сущностями в сцене
│   │
│   ├── dialogue/                # Диалоговая система
│   │   ├── DialogueManager.ts   # Показ диалогов, выборы, ветвление
│   │   ├── DialogueParser.ts    # Парсинг диалоговых файлов
│   │   └── DialogueUI.ts        # UI диалогового окна
│   │
│   ├── narrative/               # Нарративные системы
│   │   ├── QuestManager.ts      # Квесты, цели, прогресс
│   │   ├── JournalManager.ts    # Журнал расследования
│   │   ├── LoreItem.ts          # Записки, письма, документы
│   │   └── FlagSystem.ts        # Глобальные флаги состояния мира
│   │
│   ├── effects/                 # Визуальные эффекты
│   │   ├── ParticleSystem.ts    # Частицы (пыль, пар, искры, люмбрит)
│   │   ├── LightingSystem.ts    # Динамическое освещение (маска темноты + источники)
│   │   ├── LumbritEffect.ts     # Эффекты воздействия люмбрита
│   │   ├── ShaderManager.ts     # Пост-обработка, distortion, color grading
│   │   └── WeatherSystem.ts     # Капли воды, пар, пыль в воздухе
│   │
│   ├── ui/                      # Интерфейс
│   │   ├── HUD.ts               # Минимальный HUD
│   │   ├── InventoryUI.ts       # Инвентарь
│   │   ├── MapUI.ts             # Карта (заполняется по мере исследования)
│   │   ├── MenuUI.ts            # Главное меню, пауза, настройки
│   │   └── UIManager.ts         # Управление слоями UI
│   │
│   ├── rendering/               # Обёртка над PixiJS
│   │   ├── Renderer.ts          # Инициализация PixiJS, управление stage
│   │   ├── SpriteSheet.ts       # Работа с атласами спрайтов
│   │   ├── AnimationPlayer.ts   # Покадровые анимации
│   │   └── RenderLayers.ts      # Z-ordering: bg → tiles → entities → fg → lighting → UI
│   │
│   ├── audio/                   # Звук
│   │   ├── MusicManager.ts      # Фоновая музыка, кроссфейды между зонами
│   │   ├── AmbientManager.ts    # Ambient-звуки (капли, скрежет, эхо, гул машин)
│   │   └── SFXManager.ts        # Звуковые эффекты
│   │
│   ├── data/                    # Статические данные
│   │   ├── npcs/                # JSON-файлы NPC (диалоги, расписания)
│   │   ├── quests/              # JSON-файлы квестов
│   │   ├── items/               # JSON-файлы предметов
│   │   ├── maps/                # Данные тайлмапов (JSON, экспорт из Tiled)
│   │   └── lore/                # Тексты записок, писем, документов
│   │
│   ├── config/                  # Конфигурация
│   │   ├── constants.ts         # Глобальные константы (тайл-размер, гравитация и т.д.)
│   │   ├── controls.ts          # Маппинг клавиш
│   │   └── settings.ts          # Пользовательские настройки
│   │
│   └── utils/                   # Утилиты
│       ├── math.ts              # Вектора, интерполяция, случайные числа
│       ├── spatial.ts           # Spatial hash / grid для оптимизации
│       └── debug.ts             # Debug overlay, FPS, hitbox визуализация
│
├── assets/                      # Ассеты (спрайты, звуки, музыка)
│   ├── sprites/
│   ├── tilesets/
│   ├── music/
│   ├── sfx/
│   └── ambient/
│
├── tests/                       # Тесты (зеркалят структуру src/)
│   ├── core/
│   ├── physics/
│   ├── world/
│   ├── entities/
│   ├── dialogue/
│   └── narrative/
│
├── tools/                       # Утилиты разработки
│   ├── map-validator.ts         # Валидация карт
│   └── asset-pipeline.ts        # Сборка атласов, оптимизация
│
└── docs/
    ├── design.md                # Гейм-дизайн документ (этот файл)
    ├── art-guide.md             # Гайд по визуальному стилю
    └── narrative-outline.md     # Структура сюжета, персонажи, ветвления
```

### Ключевые архитектурные решения

**1. Game Loop — фиксированный timestep для физики, интерполяция для рендера**

```
while (accumulator >= FIXED_DT) {
    update(FIXED_DT)     // Физика, логика — детерминированно
    accumulator -= FIXED_DT
}
render(accumulator / FIXED_DT)  // Интерполяция для плавности
```

**2. Сцены — простые контейнеры, не фреймворк**

Сцена = набор систем + набор сущностей + данные уровня. SceneManager переключает между ними. Без магии, без lifecycle-хуков кроме `init()`, `update(dt)`, `destroy()`.

**3. Данные — JSON, редактируемые AI-агентом**

Все игровые данные (NPC, диалоги, квесты, карты) — JSON-файлы с TypeScript-типами для валидации. AI-агент может генерировать и редактировать контент напрямую, без визуального редактора.

**4. Карты — Tiled JSON + кастомный загрузчик**

Tiled Map Editor для дизайна уровней (бесплатный, экспорт в JSON). Кастомный загрузчик читает JSON и создаёт тайлмап + коллизии + зоны. AI-агент может генерировать карты программно для прототипирования.

**5. Освещение — маска темноты**

Весь экран по умолчанию тёмный. Источники света (фонарь игрока, люмбритовые жилы, лампы) рисуют «дыры» в маске через multiply blend. Простая и эффективная система для пещерной атмосферы.

**6. Chunk-based мир**

Мир разбит на чанки. ChunkManager загружает/выгружает чанки вокруг камеры. Это позволяет иметь огромный мир без проблем с памятью. Каждый чанк — отдельный JSON-файл.

---

## 4. Подход к разработке (AI-first)

### CLAUDE.md — инструкции для агента

В корне проекта лежит CLAUDE.md с:
- Описание проекта и текущее состояние
- Структура директорий и конвенции именования
- Как запускать: `npm run dev`, `npm run test`, `npm run build`
- Паттерны кода: как создавать новые сущности, новые NPC, новые зоны
- Что НЕ трогать: ядро движка после стабилизации
- Ссылки на PixiJS v8 docs для проверки API

### Цикл разработки

```
1. Описать задачу агенту (текст)
2. Агент пишет/меняет код + тесты
3. Агент запускает тесты (vitest --run)
4. Если тесты зелёные → ты запускаешь и проверяешь визуально (npm run dev)
5. Если нужны правки → описываешь что не так → повтор
```

### Тестирование

**Что тестируется автоматически (агент запускает сам):**
- Физика и коллизии
- Система квестов и флагов
- Парсинг диалогов
- Загрузка/сохранение
- Генерация/валидация карт
- Все утилиты

**Что проверяется визуально (ты смотришь):**
- Анимации и переходы
- Освещение и эффекты
- Тайминг диалогов
- Общее ощущение от управления
- Атмосфера

### Порядок разработки (фазы)

**Фаза 1 — Ядро движка (2-3 недели)**
- [ ] Game loop + рендер (PixiJS init)
- [ ] Тайлмап загрузка и рендер
- [ ] Игрок: движение, гравитация, коллизии с тайлами
- [ ] Камера с плавным следованием
- [ ] Input (клавиатура + геймпад)
- [ ] Базовое освещение (маска темноты + фонарь)
- Результат: персонаж ходит по тестовому уровню в темноте с фонарём

**Фаза 2 — Мир и навигация (2-3 недели)**
- [ ] Chunk-based загрузка
- [ ] Параллакс-фон
- [ ] Зоны-переходы между локациями
- [ ] Паровые лифты (интерактивные объекты)
- [ ] Карта (fog-of-war, заполняется при исследовании)
- [ ] Система сохранений
- Результат: можно перемещаться между уровнями Кальдерна

**Фаза 3 — NPC и диалоги (2-3 недели)**
- [ ] NPC: спрайты, idle-анимации, зона взаимодействия
- [ ] Диалоговая система с выборами
- [ ] Журнал расследования
- [ ] Система квестов и флагов
- [ ] Пневмопочта и записки (лор)
- Результат: можно разговаривать с NPC, получать квесты, собирать лор

**Фаза 4 — Атмосфера и эффекты (2-3 недели)**
- [ ] Частицы (пыль, пар, капли, искры)
- [ ] Люмбритовое свечение в стенах
- [ ] Ambient-звуки по зонам
- [ ] Музыка с кроссфейдами
- [ ] Люмбритовое воздействие (визуальные искажения)
- [ ] Пост-обработка (виньетка, color grading по глубине)
- Результат: атмосфера Кальдерна ощущается

**Фаза 5 — Контент (основной объём, 2-4 месяца)**
- [ ] Дизайн всех локаций в Tiled
- [ ] Все NPC, диалоги, квесты
- [ ] Сюжетная линия расследования дочери
- [ ] Лор: письма, записки, граффити, документы
- [ ] Уникальные механики по зонам (затопленные тоннели, обрушения, и т.д.)
- [ ] Финал — «Корень»

**Фаза 6 — Полировка и релиз (3-4 недели)**
- [ ] Tauri-сборка для Steam
- [ ] Steam-интеграция (достижения, облачные сохранения)
- [ ] Баланс, QA
- [ ] Демо для Steam Next Fest
- [ ] Трейлер, страница в Steam, маркетинг

---

## 5. Конвенции кода

### Именование

- Файлы: `PascalCase.ts` для классов, `camelCase.ts` для утилит
- Классы: `PascalCase`
- Методы/переменные: `camelCase`
- Константы: `UPPER_SNAKE_CASE`
- Типы/интерфейсы: `PascalCase`, интерфейсы без префикса `I`
- JSON данные: `kebab-case.json`

### Паттерны

- Предпочитать композицию над наследованием
- Каждый модуль экспортирует чёткий public API
- Избегать циклических зависимостей (EventBus для loose coupling)
- Все магические числа — в constants.ts
- Каждая новая система = новый файл + тесты

### TypeScript строгость

```json
{
  "compilerOptions": {
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}
```

---

## 6. Инструменты для контента

### Tiled Map Editor

- Экспорт карт в JSON
- Слои: background, collision, foreground, zones, entities
- Custom Properties для зон: тип перехода, ambient звук, уровень люмбрита
- Тайлсеты: один на зону Кальдерна (Край, Хребет, Кишки, Корень)

### Aseprite (опционально)

- Пиксель-арт спрайты и анимации
- Экспорт в spritesheet JSON (совместим с PixiJS)

### Звук

- Ambient: нарезка, loop
- Музыка: OGG для основного формата, MP3 как fallback
- Howler.js или Web Audio API напрямую

---

## 7. Деплой

### Разработка
```bash
npm run dev          # Vite dev server с HMR
npm run test         # Vitest — все тесты
npm run test:watch   # Тесты в watch-режиме
npm run lint         # ESLint + Prettier check
```

### Продакшн
```bash
npm run build        # Vite production build
npm run preview      # Локальный просмотр билда
```

### Steam (Tauri)
```bash
npm run tauri build  # Нативный билд для Windows/Mac/Linux
```

Размер билда: ~10-20MB (vs 150MB+ Electron). Включает нативный webview, не тащит Chromium.

### Web-демо
Vite build → деплой на Netlify/Vercel/itch.io. Бесплатный хостинг, мгновенный доступ для игроков. Идеально для маркетинга: ссылка → играет через 3 секунды.
